<!DOCTYPE html>
<html ng-app="textPlugin">
<head lang="en">
    <meta charset="UTF-8">
    <title>example Text widget</title>

    <script src="../../../scripts/angular/angular.min.js"></script>
    <script src="../../../scripts/jquery/jquery-1.11.2.min.js"></script>
    <script type="text/javascript" src="../../../scripts/buildfire.js"></script>
    <script type="text/javascript" src="../../../scripts/owlCarousel/owlCarousel.js"></script>

    <link href="../../../scripts/owlCarousel/owlCarousel.css" rel="stylesheet" />
</head>
<body>
    <div id="wrapper" ng-controller="textPluginCtrl" ng-cloak>
        <div id="owl-demo" class="owl-carousel owl-theme" ng-hide="data.content.carouselImages.length == 0">
            <div class="item" ng-repeat="item in data.content.carouselImages" data-index="{{ $index }}" ng-click="optionAction($index)">
                <img ng-src="{{ resizeImage(item.iconUrl, sliderHeight) }}" alt="{{ item.title }} ">
            </div>
        </div>
        <div ng-bind-html="data.content.text" class="widget-content"></div>
        <style>
            .widget-content {
                padding: 10px;
            }

            .owl-carousel .owl-item, .owl-carousel .owl-item .item, .owl-carousel .owl-item img {
                height: {{ sliderHeight }}px;
                width: 100%;
            }

            #wrapper {
                {{ data.design.backgroundImage ? 'background-image: url(' + resizeImage(data.design.backgroundImage, deviceHeight) + ')' : '' }};
                height: 100%;
            }
        </style>
    </div>
    <script>

        var textPluginApp = angular.module('textPlugin', []);

        textPluginApp.controller('textPluginCtrl', ['$scope', '$sce', function ($scope, $sce) {
            /*
            * Get the required details about the device
            * */
            $scope.deviceHeight = window.innerHeight;
            // 9/16 is best ration to the slider height
            $scope.sliderHeight = Math.floor($scope.deviceHeight * 0.5625);

            $scope.data = {
                content: {
                    carouselImages: []
                },
                design: {
                    backgroundImage: null
                }
            };

            /*
            * Check if we need to destroy and re-create the slider again
            * */
            var updateSlider = false;

            $scope.optionAction = function (index) {
                buildfire.actionItems.execute($scope.data.content.carouselImages[index], function (err, result) {
                    if (err) {
                        console.warn('Error openning slider action: ', err);
                    }
                });
            };

            /*
            * bind data to the scope
            * */
            function bind(data) {
                var slider = $("#owl-demo");
                $scope.data = data;

                if (data && data.content && data.content.text) {
                    $scope.data.content.text = $sce.trustAsHtml(data.content.text);
                }

                if (!$scope.$$phase && !$scope.$root.$$phase) {
                    $scope.$apply();
                }

                //$scope.$digest();

                var sliderData = slider.data('owlCarousel');

                if (slider.length && sliderData) {
                    if (sliderData) {
                        sliderData.destroy();
                    }
                }

                if (slider.length) {
                    var sliderOptions = {
                        navigation: false,
                        dots: false,
                        slideSpeed: 300,
                        paginationSpeed: 400,
                        singleItem: true,
                        pagination: false,
                        items: 1,
                        itemsMobile: true,
                        autoHeight: false
                    };

                    if (data.content.carouselImages.length > 1) {
                        sliderOptions.autoplay = 3000;
                        sliderOptions.autoplaySpeed = 500;
                        sliderOptions.loop = true;
                    }

                    $("#owl-demo").owlCarousel(sliderOptions);
                }
            }

            /*
             * Go pull saved data
             * */
            function loadData() {
                buildfire.datastore.get(function (err, result) {
                    if (result) bind(result.data);
                });
            }

            loadData();

            /**
             * when a refresh is triggered get reload data
             */
            buildfire.datastore.onRefresh(loadData);

            buildfire.datastore.onUpdate(function (e) {
                updateSlider = true;
                loadData();
            });

            /*
            * A helper to resie the background and slider images
            * */
            $scope.resizeImage = function (url, height) {
                if (!url) {
                    return "";
                }
                else {
                    return buildfire.imageLib.resizeImage(url, { height: height });
                }
            };
        }]);
    </script>
</body>
</html>